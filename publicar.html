<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Publicar - Local Market</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="styles.css">
    <style>
.image-upload-area{border:3px dashed #5B7B5A;border-radius:12px;padding:2rem 1rem;text-align:center;background:#E8F0E8;cursor:pointer;transition:all .3s}
.image-upload-area:hover{background:#D0E5D0}
.image-upload-area.dragover{border-color:#3E5A3D;background:#C0DFC0;transform:scale(1.02)}
.upload-icon{font-size:3rem;color:#5B7B5A;margin-bottom:1rem}
.image-previews{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:1rem;margin-top:1.5rem}
.image-preview{position:relative;border-radius:12px;overflow:hidden;aspect-ratio:1;box-shadow:0 4px 12px rgba(0,0,0,.1)}
.image-preview img{width:100%;height:100%;object-fit:cover}
.image-preview-remove{position:absolute;top:5px;right:5px;background:rgba(244,67,54,.9);color:#fff;border:none;border-radius:50%;width:35px;height:35px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1.2rem}
.image-preview-remove:hover{background:#c62828;transform:scale(1.1)}
.image-counter{display:inline-block;background:#5B7B5A;color:#fff;padding:.5rem 1rem;border-radius:50px;font-weight:600;margin-top:1rem}
.loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:9999}
.loading-content{background:#fff;padding:2rem;border-radius:12px;text-align:center;max-width:400px}

/* OPTIMIZACI√ìN M√ìVIL */
@media (max-width: 768px) {
    .image-upload-area {
        padding: 3rem 1rem;
    }
    .upload-icon {
        font-size: 4rem;
    }
    .btn-select-photos {
        font-size: 1.1rem;
        padding: 1rem 2rem;
        min-height: 60px;
    }
    .image-previews {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 0.75rem;
    }
    .image-preview-remove {
        width: 40px;
        height: 40px;
        font-size: 1.4rem;
    }
}
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top">
        <div class="container">
            <a class="navbar-brand" href="index.html"><span class="brand-text">Local<span class="brand-accent">Market</span></span></a>
            <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">Inicio</a></li>
                    <li class="nav-item"><a class="nav-link" href="catalogo.html">Cat√°logo</a></li>
                    <li class="nav-item"><a class="nav-link active" href="publicar.html">Publicar</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <section class="py-5">
        <div class="container">
            <!-- Flujo del Proceso -->
            <div class="row justify-content-center mb-4">
                <div class="col-lg-10">
                    <div class="card shadow-sm border-0 mb-4" style="background: linear-gradient(135deg, #E8F0E8 0%, #F0EBE3 100%);">
                        <div class="card-body p-4">
                            <h3 class="text-center mb-4" style="color: #5B7B5A;">
                                <i class="bi bi-info-circle me-2"></i>¬øC√≥mo Funciona?
                            </h3>
                            <div class="row g-3">
                                <div class="col-md-3 col-6 text-center">
                                    <div class="p-3">
                                        <div class="mb-2" style="font-size: 2.5rem; color: #5B7B5A;">1Ô∏è‚É£</div>
                                        <h5 style="font-size: 0.95rem;">Publicas</h5>
                                        <p class="small text-muted mb-0 d-none d-md-block">Completas el formulario con fotos</p>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6 text-center">
                                    <div class="p-3">
                                        <div class="mb-2" style="font-size: 2.5rem;">üìß</div>
                                        <h5 style="font-size: 0.95rem;">Recibes Email</h5>
                                        <p class="small text-muted mb-0 d-none d-md-block">Confirmaci√≥n inmediata</p>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6 text-center">
                                    <div class="p-3">
                                        <div class="mb-2" style="font-size: 2.5rem;">‚úÖ</div>
                                        <h5 style="font-size: 0.95rem;">Aprobaci√≥n</h5>
                                        <p class="small text-muted mb-0 d-none d-md-block">Revisamos en 24-48h</p>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6 text-center">
                                    <div class="p-3">
                                        <div class="mb-2" style="font-size: 2.5rem;">üéâ</div>
                                        <h5 style="font-size: 0.95rem;">Ya Vendiste?</h5>
                                        <p class="small text-muted mb-0 d-none d-md-block">Click en el email</p>
                                    </div>
                                </div>
                            </div>
                            <hr class="my-3">
                            <div class="text-center">
                                <small class="text-muted">
                                    <strong>üì± Compradores te contactan directo por WhatsApp</strong>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="card shadow" id="productForm">
                        <div class="card-body p-4">
                            <h1 class="text-center mb-3">Publicar Producto</h1>
                            <div class="alert alert-info text-center">
                                <strong>‚è≥ Moderaci√≥n:</strong> Tu producto ser√° revisado en 24-48 horas antes de publicarse
                            </div>

                            <form id="submitForm">
                                <h5 class="mt-4 mb-3">üì¶ Informaci√≥n</h5>
                                <div class="mb-3">
                                    <label class="form-label">Nombre *</label>
                                    <input type="text" class="form-control" name="nombre" required>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Precio (CLP) *</label>
                                        <input type="number" class="form-control" name="precio" min="0" required>
                                    </div>
                                    <!-- PARA PUBLICAR.HTML (Formulario) -->
<div class="mb-3">
    <label class="form-label">Categor√≠a *</label>
    <select class="form-select" name="categoria" required>
        <option value="">Selecciona...</option>
        <option value="muebles">Muebles</option>
        <option value="electronica">Electr√≥nica</option>
        <option value="decoracion">Decoraci√≥n</option>
        <option value="cocina">Cocina</option>
        <option value="negocio">Negocio</option>
        <option value="servicios">Servicios</option>
        <option value="ropa">Ropa y Moda</option>
        <option value="deportes">Deportes</option>
        <option value="bebes">Beb√©s y Ni√±os</option>
        <option value="libros">Libros y Medios</option>
        <option value="jardineria">Jardiner√≠a</option>
        <option value="mascotas">Mascotas</option>
        <option value="herramientas">Herramientas</option>
        <option value="vehiculos">Veh√≠culos</option>
        <option value="computacion">Computaci√≥n</option>
        <option value="musica">M√∫sica</option>
        <option value="coleccionables">Coleccionables</option>
        <option value="oficina">Oficina</option>
        <option value="eventos">Eventos</option>
        <option value="otros">Otros</option>
    </select>
</div>                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Estado *</label>
                                    <select class="form-select" name="estado" required>
                                        <option value="">Selecciona...</option>
                                        <option value="nuevo">Nuevo</option>
                                        <option value="como nuevo">Como Nuevo</option>
                                        <option value="usado">Usado</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Descripci√≥n Corta *</label>
                                    <input type="text" class="form-control" name="descripcionCorta" maxlength="100" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Descripci√≥n Detallada *</label>
                                    <textarea class="form-control" name="descripcionLarga" rows="4" required></textarea>
                                </div>

                                <h5 class="mt-4 mb-3">üìç Ubicaci√≥n</h5>
                                <div class="mb-3">
                                    <label class="form-label">Regi√≥n *</label>
                                    <select class="form-select" name="region" id="regionSelect" required>
                                        <option value="">Selecciona regi√≥n...</option>
                                        <option value="Arica y Parinacota">Arica y Parinacota</option>
                                        <option value="Tarapac√°">Tarapac√°</option>
                                        <option value="Antofagasta">Antofagasta</option>
                                        <option value="Atacama">Atacama</option>
                                        <option value="Coquimbo">Coquimbo</option>
                                        <option value="Valpara√≠so">Valpara√≠so</option>
                                        <option value="Metropolitana">Regi√≥n Metropolitana</option>
                                        <option value="O'Higgins">O'Higgins</option>
                                        <option value="Maule">Maule</option>
                                        <option value="√ëuble">√ëuble</option>
                                        <option value="Biob√≠o">Biob√≠o</option>
                                        <option value="Araucan√≠a">Araucan√≠a</option>
                                        <option value="Los R√≠os">Los R√≠os</option>
                                        <option value="Los Lagos">Los Lagos</option>
                                        <option value="Ays√©n">Ays√©n</option>
                                        <option value="Magallanes">Magallanes</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Comuna *</label>
                                    <select class="form-select" name="comuna" id="comunaSelect" required disabled>
                                        <option value="">Primero selecciona una regi√≥n</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Entrega *</label>
                                    <select class="form-select" name="entrega" required>
                                        <option value="">Selecciona...</option>
                                        <option value="Solo retiro en domicilio">Solo Retiro</option>
                                        <option value="Despacho incluido">Despacho Incluido</option>
                                        <option value="Retiro o despacho">Retiro o Despacho</option>
                                    </select>
                                </div>

                                <h5 class="mt-4 mb-3">üì∏ Fotos (M√°x 5)</h5>
                                <div class="mb-3">
                                    <!-- √Årea de upload optimizada para m√≥vil -->
                                    <div class="image-upload-area" id="uploadArea">
                                        <input type="file" id="imageInput" accept="image/*" multiple style="display:none">
                                        <div class="upload-icon"><i class="bi bi-images"></i></div>
                                        <h5 class="mb-3">Toca para seleccionar fotos</h5>
                                        <button type="button" class="btn btn-primary btn-lg btn-select-photos" onclick="document.getElementById('imageInput').click()">
                                            <i class="bi bi-camera me-2"></i>Seleccionar Fotos
                                        </button>
                                        <p class="text-muted mt-3 mb-0"><small>M√°x 5 fotos | 5MB cada una</small></p>
                                    </div>
                                    <div class="image-previews" id="imagePreviews"></div>
                                    <div class="text-center" id="imageCounter" style="display:none">
                                        <span class="image-counter"><i class="bi bi-images me-2"></i><span id="imageCount">0</span> foto(s) seleccionada(s)</span>
                                    </div>
                                </div>

                                <h5 class="mt-4 mb-3">üë§ Contacto</h5>
                                <div class="mb-3">
                                    <label class="form-label">Nombre *</label>
                                    <input type="text" class="form-control" name="vendedor" required>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">WhatsApp *</label>
                                        <input type="tel" class="form-control" name="whatsappvendedor" placeholder="56912345678" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Email *</label>
                                        <input type="email" class="form-control" name="email" required>
                                    </div>
                                </div>

                                <div class="form-check mb-4">
                                    <input class="form-check-input" type="checkbox" id="terms" required>
                                    <label class="form-check-label" for="terms">Acepto revisi√≥n previa y t√©rminos de uso</label>
                                </div>

                                <button type="submit" class="btn btn-primary w-100 btn-lg">
                                    <i class="bi bi-send me-2"></i>Enviar para Revisi√≥n
                                </button>
                            </form>
                        </div>
                    </div>

                    <div class="alert alert-success text-center d-none" id="success">
                        <h3>‚úÖ ¬°Enviado Exitosamente!</h3>
                        <p class="mb-3">Te notificaremos por email cuando tu producto sea aprobado</p>
                        <button class="btn btn-primary" onclick="location.reload()">Publicar Otro Producto</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div class="loading-overlay d-none" id="loading">
        <div class="loading-content">
            <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
            <h5 id="loadingText">Subiendo im√°genes...</h5>
            <div class="progress mt-3" style="height: 25px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" id="progress" style="width:0; font-size: 1rem;"></div>
            </div>
            <p class="mt-2 mb-0" id="status">Preparando...</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
const SCRIPT_URL='https://script.google.com/macros/s/AKfycbximqLlIYLdXtWKHv5ugP4HIZaTf0V6jgzEsEVroEZe99lnx-XfJqwCWfsWhjBvYYGJ/exec';

const MAX_IMG=5,MAX_SIZE=5*1024*1024;
let imgs=[];

// COMUNAS POR REGI√ìN
const comunasPorRegion = {
    "Arica y Parinacota": ["Arica", "Camarones", "Putre", "General Lagos"],
    "Tarapac√°": ["Iquique", "Alto Hospicio", "Pozo Almonte", "Cami√±a", "Colchane", "Huara", "Pica"],
    "Antofagasta": ["Antofagasta", "Mejillones", "Sierra Gorda", "Taltal", "Calama", "Ollag√ºe", "San Pedro de Atacama", "Tocopilla", "Mar√≠a Elena"],
    "Atacama": ["Copiap√≥", "Caldera", "Tierra Amarilla", "Cha√±aral", "Diego de Almagro", "Vallenar", "Alto del Carmen", "Freirina", "Huasco"],
    "Coquimbo": ["La Serena", "Coquimbo", "Andacollo", "La Higuera", "Paiguano", "Vicu√±a", "Illapel", "Canela", "Los Vilos", "Salamanca", "Ovalle", "Combarbal√°", "Monte Patria", "Punitaqui", "R√≠o Hurtado"],
    "Valpara√≠so": ["Valpara√≠so", "Casablanca", "Conc√≥n", "Juan Fern√°ndez", "Puchuncav√≠", "Quintero", "Vi√±a del Mar", "Isla de Pascua", "Los Andes", "Calle Larga", "Rinconada", "San Esteban", "La Ligua", "Cabildo", "Papudo", "Petorca", "Zapallar", "Quillota", "Calera", "Hijuelas", "La Cruz", "Nogales", "San Antonio", "Algarrobo", "Cartagena", "El Quisco", "El Tabo", "Santo Domingo", "San Felipe", "Catemu", "Llaillay", "Panquehue", "Putaendo", "Santa Mar√≠a", "Quilpu√©", "Limache", "Olmu√©", "Villa Alemana"],
    "Metropolitana": ["Cerrillos", "Cerro Navia", "Conchal√≠", "El Bosque", "Estaci√≥n Central", "Huechuraba", "Independencia", "La Cisterna", "La Florida", "La Granja", "La Pintana", "La Reina", "Las Condes", "Lo Barnechea", "Lo Espejo", "Lo Prado", "Macul", "Maip√∫", "√ëu√±oa", "Pedro Aguirre Cerda", "Pe√±alol√©n", "Providencia", "Pudahuel", "Quilicura", "Quinta Normal", "Recoleta", "Renca", "San Joaqu√≠n", "San Miguel", "San Ram√≥n", "Vitacura", "Puente Alto", "Pirque", "San Jos√© de Maipo", "Colina", "Lampa", "Tiltil", "San Bernardo", "Buin", "Calera de Tango", "Paine", "Melipilla", "Alhu√©", "Curacav√≠", "Mar√≠a Pinto", "San Pedro", "Talagante", "El Monte", "Isla de Maipo", "Padre Hurtado", "Pe√±aflor"],
    "O'Higgins": ["Rancagua", "Codegua", "Coinco", "Coltauco", "Do√±ihue", "Graneros", "Las Cabras", "Machal√≠", "Malloa", "Mostazal", "Olivar", "Peumo", "Pichidegua", "Quinta de Tilcoco", "Rengo", "Requ√≠noa", "San Vicente", "Pichilemu", "La Estrella", "Litueche", "Marchihue", "Navidad", "Paredones", "San Fernando", "Ch√©pica", "Chimbarongo", "Lolol", "Nancagua", "Palmilla", "Peralillo", "Placilla", "Pumanque", "Santa Cruz"],
    "Maule": ["Talca", "Constituci√≥n", "Curepto", "Empedrado", "Maule", "Pelarco", "Pencahue", "R√≠o Claro", "San Clemente", "San Rafael", "Cauquenes", "Chanco", "Pelluhue", "Curic√≥", "Huala√±√©", "Licant√©n", "Molina", "Rauco", "Romeral", "Sagrada Familia", "Teno", "Vichuqu√©n", "Linares", "Colb√∫n", "Longav√≠", "Parral", "Retiro", "San Javier", "Villa Alegre", "Yerbas Buenas"],
    "√ëuble": ["Chill√°n", "Bulnes", "Cobquecura", "Coelemu", "Coihueco", "Chill√°n Viejo", "El Carmen", "Ninhue", "√ëiqu√©n", "Pemuco", "Pinto", "Portezuelo", "Quill√≥n", "Quirihue", "R√°nquil", "San Carlos", "San Fabi√°n", "San Ignacio", "San Nicol√°s", "Treguaco", "Yungay"],
    "Biob√≠o": ["Concepci√≥n", "Coronel", "Chiguayante", "Florida", "Hualqui", "Lota", "Penco", "San Pedro de la Paz", "Santa Juana", "Talcahuano", "Tom√©", "Hualp√©n", "Lebu", "Arauco", "Ca√±ete", "Contulmo", "Curanilahue", "Los √Ålamos", "Tir√∫a", "Los √Ångeles", "Antuco", "Cabrero", "Laja", "Mulch√©n", "Nacimiento", "Negrete", "Quilaco", "Quilleco", "San Rosendo", "Santa B√°rbara", "Tucapel", "Yumbel", "Alto Biob√≠o"],
    "Araucan√≠a": ["Temuco", "Carahue", "Cunco", "Curarrehue", "Freire", "Galvarino", "Gorbea", "Lautaro", "Loncoche", "Melipeuco", "Nueva Imperial", "Padre Las Casas", "Perquenco", "Pitrufqu√©n", "Puc√≥n", "Saavedra", "Teodoro Schmidt", "Tolt√©n", "Vilc√∫n", "Villarrica", "Cholchol", "Angol", "Collipulli", "Curacaut√≠n", "Ercilla", "Lonquimay", "Los Sauces", "Lumaco", "Pur√©n", "Renaico", "Traigu√©n", "Victoria"],
    "Los R√≠os": ["Valdivia", "Corral", "Lanco", "Los Lagos", "M√°fil", "Mariquina", "Paillaco", "Panguipulli", "La Uni√≥n", "Futrono", "Lago Ranco", "R√≠o Bueno"],
    "Los Lagos": ["Puerto Montt", "Calbuco", "Cocham√≥", "Fresia", "Frutillar", "Los Muermos", "Llanquihue", "Maull√≠n", "Puerto Varas", "Castro", "Ancud", "Chonchi", "Curaco de V√©lez", "Dalcahue", "Puqueld√≥n", "Queil√©n", "Quell√≥n", "Quemchi", "Quinchao", "Osorno", "Puerto Octay", "Purranque", "Puyehue", "R√≠o Negro", "San Juan de la Costa", "San Pablo", "Chait√©n", "Futaleuf√∫", "Hualaihu√©", "Palena"],
    "Ays√©n": ["Coyhaique", "Lago Verde", "Ays√©n", "Cisnes", "Guaitecas", "Cochrane", "O'Higgins", "Tortel", "Chile Chico", "R√≠o Ib√°√±ez"],
    "Magallanes": ["Punta Arenas", "Laguna Blanca", "R√≠o Verde", "San Gregorio", "Cabo de Hornos", "Ant√°rtica", "Porvenir", "Primavera", "Timaukel", "Natales", "Torres del Paine"]
};

// CARGAR COMUNAS DIN√ÅMICAMENTE
document.getElementById('regionSelect').addEventListener('change', function() {
    const region = this.value;
    const comunaSelect = document.getElementById('comunaSelect');
    
    if (region && comunasPorRegion[region]) {
        comunaSelect.disabled = false;
        comunaSelect.innerHTML = '<option value="">Selecciona comuna...</option>';
        comunasPorRegion[region].forEach(comuna => {
            const option = document.createElement('option');
            option.value = comuna;
            option.textContent = comuna;
            comunaSelect.appendChild(option);
        });
    } else {
        comunaSelect.disabled = true;
        comunaSelect.innerHTML = '<option value="">Primero selecciona una regi√≥n</option>';
    }
});

const area=document.getElementById('uploadArea'),input=document.getElementById('imageInput');

// Click en √°rea (funciona en m√≥vil y desktop)
area.onclick=(e)=>{
    // Solo abrir selector si no se hizo click en el bot√≥n
    if(!e.target.closest('.btn-select-photos')){
        input.click();
    }
};

// Drag & drop solo para desktop
if(window.innerWidth > 768){
    area.ondragover=e=>{e.preventDefault();area.classList.add('dragover')};
    area.ondragleave=()=>area.classList.remove('dragover');
    area.ondrop=e=>{e.preventDefault();area.classList.remove('dragover');handleFiles(e.dataTransfer.files)};
}

// Cambio en input file (funciona en todos los dispositivos)
input.onchange=e=>handleFiles(e.target.files);

function handleFiles(files){
    const arr=Array.from(files);
    if(imgs.length+arr.length>MAX_IMG){
        alert('M√°ximo '+MAX_IMG+' fotos permitidas');
        return;
    }
    
    arr.forEach(f=>{
        if(!f.type.match('image.*')){
            alert(f.name+': Solo se permiten im√°genes');
            return;
        }
        if(f.size>MAX_SIZE){
            alert(f.name+': Tama√±o m√°ximo 5MB');
            return;
        }
        
        imgs.push(f);
        const r=new FileReader();
        r.onload=e=>{
            const d=document.createElement('div');
            d.className='image-preview';
            d.dataset.name=f.name;
            d.innerHTML=`<img src="${e.target.result}" alt="${f.name}"><button type="button" class="image-preview-remove" onclick="rmImg('${f.name}')"><i class="bi bi-x"></i></button>`;
            document.getElementById('imagePreviews').appendChild(d);
        };
        r.readAsDataURL(f);
    });
    updateCounter();
}

function rmImg(name){
    imgs=imgs.filter(i=>i.name!==name);
    document.querySelector(`[data-name="${name}"]`).remove();
    updateCounter();
}

function updateCounter(){
    const c=document.getElementById('imageCounter'),n=document.getElementById('imageCount');
    if(imgs.length>0){
        c.style.display='block';
        n.textContent=imgs.length;
        input.removeAttribute('required');
    }
    else{
        c.style.display='none';
        input.setAttribute('required','required');
    }
}

function toBase64(f){
    return new Promise((res,rej)=>{
        const r=new FileReader();
        r.onload=()=>res(r.result.split(',')[1]);
        r.onerror=rej;
        r.readAsDataURL(f);
    });
}

document.getElementById('submitForm').onsubmit=async e=>{
    e.preventDefault();
    if(imgs.length===0){
        alert('Debes subir al menos 1 foto de tu producto');
        return;
    }
    
    document.getElementById('loading').classList.remove('d-none');
    
    try{
        document.getElementById('status').textContent='Procesando im√°genes...';
        const imgData=await Promise.all(imgs.map(async(f,i)=>{
            document.getElementById('progress').style.width=((i+1)/imgs.length*50)+'%';
            document.getElementById('progress').textContent=Math.round((i+1)/imgs.length*50)+'%';
            const b64=await toBase64(f);
            return{name:f.name,data:b64,mimeType:f.type};
        }));
        
        const fd=new FormData(e.target),data={};
        for(let[k,v]of fd.entries())data[k]=v;
        data.images=imgData;
        data.ubicacion=data.comuna+' - '+data.region;
        data.fechaPublicacion=new Date().toISOString().split('T')[0];
        data.disponibilidad='pendiente';
        data.destacado='FALSE';
        
        document.getElementById('loadingText').textContent='Guardando en servidor...';
        document.getElementById('status').textContent='Subiendo a Google Drive...';
        document.getElementById('progress').style.width='75%';
        document.getElementById('progress').textContent='75%';
        
        await fetch(SCRIPT_URL,{
            method:'POST',
            mode:'no-cors',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify(data)
        });
        
        document.getElementById('progress').style.width='100%';
        document.getElementById('progress').textContent='100%';
        await new Promise(r=>setTimeout(r,500));
        
        document.getElementById('loading').classList.add('d-none');
        document.getElementById('productForm').classList.add('d-none');
        document.getElementById('success').classList.remove('d-none');
        window.scrollTo({top:0,behavior:'smooth'});
        
    }catch(err){
        console.error(err);
        document.getElementById('loading').classList.add('d-none');
        alert('Error al enviar. Por favor intenta de nuevo.');
    }
};

document.querySelector('[name="whatsappvendedor"]').oninput=e=>{
    let v=e.target.value.replace(/\D/g,'');
    if(v&&!v.startsWith('56'))v='56'+v;
    e.target.value=v;
};
    </script>
</body>
</html>